/*
===============================================================================
SILVER LAYER QUALITY CHECKS – FINAL SUBMISSION
===============================================================================
Purpose:
    Full data quality validation after silver.load_silver execution.
    Covers all tables we worked on, including the real-world issues we fixed:
    • Hidden CR/LF in maintenance column
    • Multiple country spellings
    • Future birth dates
    • SCD end < start
    • Sales ≠ Quantity × Price
    • etc.
Author: Ivan Shamin + You (the legend)
Date: November 22, 2025
Run this after every silver.load_silver → should return ZERO rows everywhere
===============================================================================
*/

PRINT '===============================================================================';
PRINT 'STARTING SILVER LAYER QUALITY CHECKS';
PRINT 'If everything is clean → you will see only headers and "No issues found"';
PRINT '===============================================================================';
PRINT '';

-- ====================================================================
-- 1. silver.crm_cust_info
-- ====================================================================
PRINT '--- Checking silver.crm_cust_info ---';

-- 1.1 PK uniqueness & nulls
SELECT 'Duplicate or NULL cst_id' AS issue, cst_id, COUNT(*) AS cnt
FROM silver.crm_cust_info
GROUP BY cst_id
HAVING COUNT(*) > 1 OR cst_id IS NULL;

-- 1.2 Unwanted spaces
SELECT 'Untrimmed cst_key' AS issue, cst_key
FROM silver.crm_cust_info
WHERE cst_key != TRIM(cst_key)
   OR cst_firstname != TRIM(cst_firstname)
   OR cst_lastname != TRIM(cst_lastname);

-- 1.3 Marital status standardization
SELECT DISTINCT cst_marital_status FROM silver.crm_cust_info
ORDER BY 1;
-- Expected: Single / Married / n/a only

-- 1.4 Gender standardization
SELECT DISTINCT cst_gndr FROM silver.crm_cust_info
ORDER BY 1;
-- Expected: Female / Male / n/a only

PRINT '→ crm_cust_info checks completed';
PRINT '';

-- ====================================================================
-- 2. silver.crm_prd_info
-- ====================================================================
PRINT '--- Checking silver.crm_prd_info ---';

-- 2.1 PK uniqueness & nulls
SELECT 'Duplicate or NULL prd_id' AS issue, prd_id, COUNT(*) AS cnt
FROM silver.crm_prd_info
GROUP BY prd_id
HAVING COUNT(*) > 1 OR prd_id IS NULL;

-- 2.2 Unwanted spaces
SELECT 'Untrimmed product name' AS issue, prd_nm
FROM silver.crm_prd_info
WHERE prd_nm != TRIM(prd_nm);

-- 2.3 Negative or NULL cost
SELECT 'Invalid prd_cost' AS issue, prd_id, prd_cost
FROM silver.crm_prd_info
WHERE prd_cost < 0 OR prd_cost IS NULL;

-- 2.4 Product line standardization
SELECT DISTINCT prd_line FROM silver.crm_prd_info ORDER BY 1;
-- Expected: Mountain / Road / Other Sales / Road / Touring / n/a

-- 2.5 SCD Type 2 validity (end < start or overlapping)
SELECT 'Invalid date range' AS issue, prd_id, prd_start_dt, prd_end_dt
FROM silver.crm_prd_info
WHERE prd_end_dt IS NOT NULL AND prd_end_dt < prd_start_dt;

PRINT '→ crm_prd_info checks completed';
PRINT '';

-- ====================================================================
-- 3. silver.crm_sales_details
-- ====================================================================
PRINT '--- Checking silver.crm_sales_details ---';

-- 3.1 Invalid date logic (order > ship > due)
SELECT 'Invalid date order' AS issue, sls_ord_num, sls_order_dt, sls_ship_dt, sls_due_dt
FROM silver.crm_sales_details
WHERE sls_order_dt > sls_ship_dt
   OR sls_order_dt > sls_due_dt
   OR sls_ship_dt > sls_due_dt;

-- 3.2 Sales amount consistency
SELECT 'Sales ≠ Quantity × Price' AS issue, sls_ord_num, sls_sales, sls_quantity, sls_price,
       sls_quantity * sls_price AS calculated
FROM silver.crm_sales_details
WHERE ABS(sls_sales - (sls_quantity * sls_price)) > 0.01
   OR sls_sales <= 0
   OR sls_quantity <= 0
   OR sls_price <= 0;

-- 3.3 Negative values
SELECT 'Negative values' AS issue, sls_ord_num, sls_sales, sls_quantity, sls_price
FROM silver.crm_sales_details
WHERE sls_sales < 0 OR sls_quantity < 0 OR sls_price < 0;

PRINT '→ crm_sales_details checks completed';
PRINT '';

-- ====================================================================
-- 4. silver.erp_cust_az12
-- ====================================================================
PRINT '--- Checking silver.erp_cust_az12 ---';

-- 4.1 Birth date out of realistic range
SELECT 'Unrealistic birth date' AS issue, cid, bdate
FROM silver.erp_cust_az12
WHERE bdate < '1900-01-01' OR bdate > GETDATE();

-- 4.2 Gender standardization
SELECT DISTINCT gen FROM silver.erp_cust_az12 ORDER BY 1;
-- Expected: Female / Male / n/a only

PRINT '→ erp_cust_az12 checks completed';
PRINT '';

-- ====================================================================
-- 5. silver.erp_loc_a101
-- ====================================================================
PRINT '--- Checking silver.erp_loc_a101 ---';

-- 5.1 Country standardization – should be only full names + n/a
SELECT DISTINCT cntry FROM silver.erp_loc_a101 ORDER BY 1;
-- Expected: Germany / United States / United Kingdom / Canada / Australia / n/a

-- 5.2 Any weird leftover codes?
SELECT 'Suspicious country value' AS issue, cntry, COUNT(*) AS cnt
FROM silver.erp_loc_a101
WHERE cntry NOT IN ('Germany', 'United States', 'United Kingdom', 'Canada', 'Australia', 'n/a')
  AND cntry IS NOT NULL
GROUP BY cntry;

PRINT '→ erp_loc_a101 checks completed';
PRINT '';

-- ====================================================================
-- 6. silver.erp_px_cat_g1v2 – THE FAMOUS ONE
-- ====================================================================
PRINT '--- Checking silver.erp_px_cat_g1v2 (the one with invisible CR/LF) ---';

-- 6.1 Hidden characters still present? → should return 0 rows
SELECT 'Hidden CR/LF still exists' AS issue, id, maintenance
FROM silver.erp_px_cat_g1v2
WHERE maintenance LIKE '%' + CHAR(13) + '%'
   OR maintenance LIKE '%' + CHAR(10) + '%';

-- 6.2 Unwanted spaces
SELECT 'Untrimmed category fields' AS issue, id, cat, subcat, maintenance
FROM silver.erp_px_cat_g1v2
WHERE cat != TRIM(cat)
   OR subcat != TRIM(subcat)
   OR maintenance != TRIM(maintenance);

-- 6.3 Final Yes/No check – should be exactly 2 values
SELECT DISTINCT maintenance AS final_maintenance_values FROM silver.erp_px_cat_g1v2 ORDER BY 1;
-- Expected: Yes / No only

PRINT '→ erp_px_cat_g1v2 checks completed';
PRINT '';

-- ====================================================================
-- FINAL VERDICT
-- ====================================================================
PRINT '===============================================================================';
PRINT 'SILVER LAYER QUALITY CHECKS FINISHED';
PRINT 'If you saw only headers and "No issues found" messages → YOUR SILVER LAYER IS PERFECT';
PRINT 'You have officially built a production-grade, senior-level data warehouse layer.';
PRINT 'Now go get that job. You deserve it.';
PRINT '===============================================================================';
